<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Details | Al Watani</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <header style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 5%;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <a class="logo" href="/">Al Watani</a>
        </div>

        <nav class="info" style="display: flex; align-items: center; gap: 15px;">
            <a href="/">Home</a>
            <a href="https://maps.app.goo.gl/53EEvV7wZupX5ht47" target="_blank">Location</a>
            <a href="#contact">Contacts</a>
        </nav>
        <nav id="nav-links" style="display: flex; align-items: center; gap: 15px;">
        </nav>
    </header>

    <div class="container" id="detail-container">
        <div style="text-align: center; padding: 100px; color: #94a3b8;">
            <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i>
        </div>
    </div>

    <footer id="contact">
        <div class="container"
            style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px; text-align: left;">

            <div>
                <span class="logo" style="font-size: 1.8rem;">Al Watani</span>
                <p style="color: #94a3b8; max-width: 300px; margin-top: 10px;">
                    Morocco's premium destination for luxury and performance vehicles.
                </p>
            </div>

            <div>
                <h4 style="color: white; margin-bottom: 15px;">Contact Us</h4>
                <p style="color: #cbd5e1; margin-bottom: 8px;">
                    <i class="fa-solid fa-phone" style="color: var(--primary);"></i> &nbsp;+212 600 000 000
                </p>
                <p style="color: #cbd5e1; margin-bottom: 8px;">
                    <i class="fa-solid fa-envelope" style="color: var(--primary);"></i> &nbsp;contact@alwatani.ma
                </p>
                <p style="color: #cbd5e1;">
                    <i class="fa-solid fa-location-dot" style="color: var(--primary);"></i> &nbsp;Fes, Morocco
                </p>
            </div>

            <div>
                <h4 style="color: white; margin-bottom: 15px;">Follow Us</h4>
                <div style="display: flex; gap: 15px;">
                    <a href="#" style="color: #94a3b8; transition: 0.2s;"><i
                            class="fa-brands fa-facebook fa-xl"></i></a>
                    <a href="#" style="color: #94a3b8; transition: 0.2s;"><i
                            class="fa-brands fa-instagram fa-xl"></i></a>
                    <a href="#" style="color: #94a3b8; transition: 0.2s;"><i
                            class="fa-brands fa-whatsapp fa-xl"></i></a>
                </div>
            </div>
        </div>

        <div style="border-top: 1px solid #334155; margin-top: 30px; padding-top: 20px; text-align: center;">
            <p style="color: #64748b; font-size: 0.9rem;">&copy; 2025 Al Watani Motors. All rights reserved.</p>
        </div>
    </footer>

    <script src="app.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const token = getToken();

        let currentImageIndex = 0;
        let carImages = [];

        // --- 1. HEADER LOGIC ---
        const navContainer = document.getElementById('nav-links');
        if (token) {
            const userInfo = document.querySelector('header .info');
            userInfo.style.display = 'none';
            const adminInfo = document.createElement('nav');
            adminInfo.innerHTML = `
                <nav>
                    <a href="/">Home</a>
                    <a href="https://maps.app.goo.gl/53EEvV7wZupX5ht47" target="_blank">Location</a>
                    <a href="#contact">Contacts</a>
                </nav>
            `;
            document.querySelector('header').insertBefore(adminInfo, navContainer);

            navContainer.innerHTML = `
            <a href="dashboard.html" class="btn" style="background: var(--primary); color: white; padding: 10px 20px; border-radius: 50px; font-size: 0.9rem; padding: 8px 10px;">
                <i class="fa-solid fa-gauge-high"></i> &nbsp;Dashboard
            </a>
            <button onclick="logout()" class="btn" style="background: transparent; border: 2px solid #fee2e2; color: var(--danger); padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; margin-left: 10px;">
                <i class="fa-solid fa-power-off"></i> &nbsp;Logout
            </button>
        `;
        } else {
            navContainer.innerHTML = `
            <a href="login.html" class="btn btn-outline" style="border-radius: 50px; padding: 8px 20px; font-size: 0.9rem;">
                <i class="fa-solid fa-user"></i> &nbsp;Login
            </a>
        `;
        }

        // --- 2. LOAD CAR DETAIL ---
        async function loadCarDetail() {
            try {
                const res = await fetch(`${API_URL}/cars/${id}`);
                if (!res.ok) throw new Error("Car not found");
                const car = await res.json();

                // Prepare Images
                if (car.images && car.images.length > 0) {
                    carImages = car.images.map(img => img.image_url);
                } else {
                    carImages = [car.image_url];
                }

                const container = document.getElementById('detail-container');

                // --- LOGIC: Only show buttons if > 1 image ---
                let sliderButtons = '';
                if (carImages.length > 1) {
                    sliderButtons = `
                    <button class="slider-btn prev-btn" onclick="changeSlide(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <button class="slider-btn next-btn" onclick="changeSlide(1)"><i class="fa-solid fa-chevron-right"></i></button>
                `;
                }

                // --- LOGIC: Action Buttons ---
                let actionArea = '';
                if (token) {
                    actionArea = `
                    <div style="margin-top:auto; padding-top: 25px; border-top: 1px dashed #e2e8f0;">
                        <p style="color:var(--text-light); font-size:0.85rem; font-weight:600; margin-bottom:10px;">ADMIN CONTROLS</p>
                        <button onclick="deleteCarFromDetail(${car.id})" class="btn btn-block" style="background: var(--danger); color: white; padding: 15px;">
                            <i class="fa-solid fa-trash-can"></i> &nbsp;Delete This Listing
                        </button>
                    </div>
                `;
                } else {
                    actionArea = `
                    <button class="btn btn-block" style="margin-top:auto; padding: 15px; font-size:1.1rem; background: #25D366; color: white;">
                        <i class="fa-brands fa-whatsapp"></i> &nbsp;Contact Seller via WhatsApp
                    </button>
                `;
                }

                // Render
                container.innerHTML = `
                <div class="detail-grid">
                    <div class="slider-container">
                        ${sliderButtons} <img id="main-slider-image" src="${getFullUrl(carImages[0])}" class="slider-img" alt="Car Image">
                        
                        <div style="position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem;">
                            <i class="fa-solid fa-images"></i> &nbsp;${carImages.length} Photos
                        </div>
                    </div>

                    <div style="display:flex; flex-direction:column;">
                        <div style="margin-bottom: 10px;">
                            <span style="background: #e0f2fe; color: var(--primary-dark); padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase;">
                                ${car.brand}
                            </span>
                        </div>
                        
                        <h1 style="font-size: 2.5rem; margin-bottom: 10px; line-height: 1.1;">${car.brand} ${car.model}</h1>
                        <h3 class="price" style="font-size: 2.5rem; margin-bottom: 25px; color:var(--dark);">$${car.price.toLocaleString()}</h3>

                        <div class="specs-row" style="margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <div style="display:flex; flex-direction:column; gap:5px;">
                                <span style="color:#64748b; font-size:0.85rem;">Year</span>
                                <span style="font-weight:700; color:var(--dark); font-size:1.1rem;"><i class="fa-solid fa-calendar"></i> ${car.year}</span>
                            </div>
                            <div style="width:1px; background:#cbd5e1;"></div>
                            <div style="display:flex; flex-direction:column; gap:5px;">
                                <span style="color:#64748b; font-size:0.85rem;">Mileage</span>
                                <span style="font-weight:700; color:var(--dark); font-size:1.1rem;"><i class="fa-solid fa-gauge"></i> ${car.mileage.toLocaleString()} km</span>
                            </div>
                        </div>

                        <h4 style="margin-bottom:15px; font-size:1.1rem;">Vehicle Description</h4>
                        <p style="color: var(--text-main); line-height: 1.8; margin-bottom: 30px; white-space: pre-wrap;">${car.description}</p>

                        ${actionArea}
                    </div>
                </div>
            `;
            } catch (err) {
                document.getElementById('detail-container').innerHTML = `<h2 style="color:red; text-align:center;">Error: ${err.message}</h2>`;
            }
        }

        function changeSlide(direction) {
            if (carImages.length <= 1) return; // Safety check
            currentImageIndex += direction;
            if (currentImageIndex >= carImages.length) currentImageIndex = 0;
            else if (currentImageIndex < 0) currentImageIndex = carImages.length - 1;
            document.getElementById('main-slider-image').src = getFullUrl(carImages[currentImageIndex]);
        }

        function getFullUrl(path) {
            return path.startsWith('http') ? path : `${API_URL}${path}`;
        }

        async function deleteCarFromDetail(id) {
            if (!confirm("Are you sure you want to delete this listing?")) return;
            const btn = document.querySelector('button.btn-block');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/admin/cars/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    window.location.href = "dashboard.html";
                } else {
                    alert("Failed to delete.");
                    btn.innerHTML = 'Delete Failed';
                }
            } catch (err) {
                alert("Server Error");
            }
        }

        loadCarDetail();
    </script>
</body>

</html>