<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Details | Al Watani</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Responsive Specs Grid */
        .specs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* Desktop: 3 cols */
            gap: 20px;
            margin: 30px 0;
            padding: 20px 0;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }

        @media (max-width: 900px) {
            .specs-grid {
                grid-template-columns: 1fr 1fr;
            }

            /* Tablet: 2 cols */
        }

        @media (max-width: 600px) {
            .specs-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            /* Phone: 1 col */

            /* Fix inline header style on mobile */
            header {
                flex-direction: column !important;
                gap: 15px !important;
                height: auto !important;
                padding: 15px !important;
            }

            header nav {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
        }

        .spec-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .spec-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
            color: var(--dark);
        }

        .spec-content {
            display: flex;
            flex-direction: column;
        }

        .spec-value {
            font-weight: 700;
            color: var(--dark);
            font-size: 1rem;
        }

        .spec-label {
            color: #64748b;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>

    <header style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 5%;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <a class="logo" href="/">Al Watani</a>
        </div>
        <nav class="info" style="display: flex; align-items: center; gap: 15px;">
            <a href="/">Home</a>
            <a href="https://maps.app.goo.gl/53EEvV7wZupX5ht47" target="_blank">Location</a>
            <a href="#contact">Contacts</a>
        </nav>
        <nav id="nav-links" style="display: flex; align-items: center; gap: 15px;"></nav>
    </header>

    <div class="container" id="detail-container">
        <div style="text-align: center; padding: 100px; color: #94a3b8;"><i
                class="fa-solid fa-circle-notch fa-spin fa-2x"></i></div>
    </div>

    <footer id="contact">
        <div class="container" style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px; text-align: left;">
            <div>
                <span class="logo" style="font-size: 1.8rem;">Al Watani</span>
                <p style="color: #94a3b8; max-width: 300px; margin-top: 10px;">
                    Morocco's premium destination for luxury and performance vehicles.
                </p>
            </div>
            <div>
                <h4 style="color: white; margin-bottom: 15px;">Contact Us</h4>
                <p style="color: #cbd5e1; margin-bottom: 8px;"><i class="fa-solid fa-phone" style="color: var(--primary);"></i>  +212 661 360 143</p>
                <p style="color: #cbd5e1; margin-bottom: 8px;"><i class="fa-solid fa-envelope" style="color: var(--primary);"></i>  contact@alwatani.ma</p>
                <p style="color: #cbd5e1;"><i class="fa-solid fa-location-dot" style="color: var(--primary);"></i>  Oujda, Morocco</p>
            </div>
            <div>
                <h4 style="color: white; margin-bottom: 15px;">Follow Us</h4>
                <div style="display: flex; gap: 15px;">
                    <a href="#" style="color: #94a3b8;"><i class="fa-brands fa-facebook fa-xl"></i></a>
                    <a href="#" style="color: #94a3b8;"><i class="fa-brands fa-instagram fa-xl"></i></a>
                    <a href="#" style="color: #94a3b8;"><i class="fa-brands fa-whatsapp fa-xl"></i></a>
                </div>
            </div>
        </div>
        <div style="border-top: 1px solid #334155; margin-top: 30px; padding-top: 20px; text-align: center;">
            <p style="color: #64748b; font-size: 0.9rem;">© 2025 Al Watani Motors. All rights reserved.</p>
        </div>
    </footer>

    <script src="app.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const token = getToken();
        let currentImageIndex = 0;
        let carImages = [];

        function formatNumber(num) { return num.toLocaleString('en-US').replace(/,/g, ' '); }

        const navContainer = document.getElementById('nav-links');
        if (token) {
            document.querySelector('header .info').style.display = 'none';
            const adminInfo = document.createElement('nav');
            adminInfo.innerHTML = `<nav><a href="/">Home</a><a href="https://maps.app.goo.gl/53EEvV7wZupX5ht47" target="_blank">Location</a><a href="#contact">Contacts</a></nav>`;
            document.querySelector('header').insertBefore(adminInfo, navContainer);
            navContainer.innerHTML = `<a href="dashboard.html" class="btn" style="background: var(--primary); color: white; border-radius: 50px; font-size: 0.9rem; padding: 8px 10px;"><i class="fa-solid fa-gauge-high"></i>  Dashboard</a><button onclick="logout()" class="btn" style="background: transparent; border: 2px solid #fee2e2; color: var(--danger); padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; margin-left: 0px;"><i class="fa-solid fa-power-off"></i>  Logout</button>`;
        } else {
            navContainer.innerHTML = `<a href="login.html" class="btn btn-outline" style="border-radius: 50px; padding: 8px 20px; font-size: 0.9rem;"><i class="fa-solid fa-user"></i>  Login</a>`;
        }

        async function loadCarDetail() {
            try {
                const res = await fetch(`${API_URL}/cars/${id}`);
                if (!res.ok) throw new Error("Car not found");
                const car = await res.json();
                if (car.images && car.images.length > 0) { carImages = car.images.map(img => img.image_url); } else { carImages = [car.image_url]; }
                const container = document.getElementById('detail-container');
                let sliderButtons = '';
                if (carImages.length > 1) {
                    sliderButtons = `<button class="slider-btn prev-btn" onclick="changeSlide(-1)"><i class="fa-solid fa-chevron-left"></i></button><button class="slider-btn next-btn" onclick="changeSlide(1)"><i class="fa-solid fa-chevron-right"></i></button>`;
                }
                let actionArea = token ?
                    `<div style="margin-top:auto; padding-top: 25px; border-top: 1px dashed #e2e8f0;"><p style="color:var(--text-light); font-size:0.85rem; font-weight:600; margin-bottom:10px;">ADMIN CONTROLS</p><button onclick="deleteCarFromDetail(${car.id})" class="btn btn-block" style="background: var(--danger); color: white; padding: 15px;"><i class="fa-solid fa-trash-can"></i>  Delete This Listing</button></div>` :
                    `<button class="btn btn-block" style="margin-top:auto; padding: 15px; font-size:1.1rem; background: #25D366; color: white;"><i class="fa-brands fa-whatsapp"></i>  Contact Seller via WhatsApp</button>`;

                const transmission = car.transmission || "-";
                const fuel = car.fuel_type || "-";
                const doors = car.doors || "-";
                const origin = car.origin || "-";
                const fiscal = car.fiscal_power || "-";
                const condition = car.condition || "-";

                container.innerHTML = `
                <div class="detail-grid">
                    <div class="slider-container">
                        ${sliderButtons} <img id="main-slider-image" src="${getFullUrl(carImages[0])}" class="slider-img" alt="Car Image">
                        <div style="position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem;"><i class="fa-solid fa-images"></i>  ${carImages.length} Photos</div>
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <div style="margin-bottom: 10px;"><span style="background: #e0f2fe; color: var(--primary-dark); padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase;">${car.brand}</span></div>
                        <h1 style="font-size: 2.5rem; margin-bottom: 10px; line-height: 1.1;">${car.brand} ${car.model}</h1>
                        <h3 class="price" style="font-size: 2.5rem; margin-bottom: 25px; color:var(--dark);">${formatNumber(car.price)} DH</h3>

                        <div class="specs-grid">
                            <div class="spec-item"><i class="fa-solid fa-calendar spec-icon"></i><div class="spec-content"><span class="spec-value">${car.year}</span><span class="spec-label">Année-Modèle</span></div></div>
                            <div class="spec-item"><i class="fa-solid fa-gears spec-icon"></i><div class="spec-content"><span class="spec-value">${transmission}</span><span class="spec-label">Boite de vitesses</span></div></div>
                            <div class="spec-item"><i class="fa-solid fa-gas-pump spec-icon"></i><div class="spec-content"><span class="spec-value">${fuel}</span><span class="spec-label">Type de carburant</span></div></div>
                            <div class="spec-item"><i class="fa-solid fa-gauge spec-icon"></i><div class="spec-content"><span class="spec-value">${formatNumber(car.mileage)}</span><span class="spec-label">Kilométrage</span></div></div>
                            <div class="spec-item"><i class="fa-solid fa-car spec-icon"></i><div class="spec-content"><span class="spec-value">${car.brand}</span><span class="spec-label">Marque</span></div></div>
                            <div class="spec-item"><i class="fa-solid fa-car-side spec-icon"></i><div class="spec-content"><span class="spec-value">${car.model}</span><span class="spec-label">Modèle</span></div></div>
                            <div class="spec-item"><i class="fa-solid fa-door-open spec-icon"></i><div class="spec-content"><span class="spec-value">${doors}</span><span class="spec-label">Nombre de portes</span></div></div>
                            <div class="spec-item"><i class="fa-solid fa-flag spec-icon"></i><div class="spec-content"><span class="spec-value">${origin}</span><span class="spec-label">Origine</span></div></div>
                            <div class="spec-item"><i class="fa-solid fa-fire spec-icon"></i><div class="spec-content"><span class="spec-value">${fiscal} CV</span><span class="spec-label">Puissance fiscale</span></div></div>
                            <div class="spec-item"><i class="fa-solid fa-star spec-icon"></i><div class="spec-content"><span class="spec-value">${condition}</span><span class="spec-label">État</span></div></div>
                        </div>

                        <h4 style="margin-bottom:15px; font-size:1.1rem;">Vehicle Description</h4>
                        <p style="color: var(--text-main); line-height: 1.8; margin-bottom: 30px; white-space: pre-wrap;">${car.description}</p>
                        ${actionArea}
                    </div>
                </div>`;
            } catch (err) { document.getElementById('detail-container').innerHTML = `<h2 style="color:red; text-align:center;">Error: ${err.message}</h2>`; }
        }

        function changeSlide(direction) {
            if (carImages.length <= 1) return;
            currentImageIndex += direction;
            if (currentImageIndex >= carImages.length) currentImageIndex = 0;
            else if (currentImageIndex < 0) currentImageIndex = carImages.length - 1;
            document.getElementById('main-slider-image').src = getFullUrl(carImages[currentImageIndex]);
        }
        function getFullUrl(path) { return path.startsWith('http') ? path : `${API_URL}${path}`; }
        async function deleteCarFromDetail(id) {
            if (!confirm("Are you sure?")) return;
            const btn = document.querySelector('button.btn-block');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...'; btn.disabled = true;
            try {
                const res = await fetch(`${API_URL}/admin/cars/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) { window.location.href = "dashboard.html"; } else { alert("Failed to delete."); btn.innerHTML = 'Delete Failed'; }
            } catch (err) { alert("Server Error"); }
        }
        loadCarDetail();
    </script>
</body>

</html>